<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>A Blog | by ylgrgyq</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-80224793-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">A Blog</h1><a id="logo" href="/.">A Blog</a><p class="description">by ylgrgyq</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title"><a href="/2017/11/11/netty-resource-leack-detector/">Netty 的资源泄露探测机制</a></h1><div class="post-meta">2017-11-11</div><div class="post-content"><p>这里资源泄露主要是指某个对象占用有某些资源，比如连接、内存等，在这个对象被 GC 之前，必须主动执行一个方法，如 close、release 之类的，将其占用的资源释放出来，该对象才能被安全的 GC。否则就会出现资源泄露，比如连接没有关闭，内存没有释放。随着服务的运行，泄露的资源由于无法被释放，整个服务占用的资源就会越来越多，最终让服务无法分配新资源，导致服务异常。</p></div><p class="readmore"><a href="/2017/11/11/netty-resource-leack-detector/">Read More</a></p></div><div class="post"><h1 class="post-title"><a href="/2017/09/25/transmittable-thread-local/">线程之间传递 ThreadLocal 对象</a></h1><div class="post-meta">2017-09-25</div><div class="post-content"><p>一起看这么个场景，大致上是下面这样，是 clojure 的代码，或者说伪码：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">(<span class="name"><span class="builtin-name">defonce</span></span> ^<span class="symbol">:dynamic</span> *utc* <span class="literal">false</span>)</div><div class="line"></div><div class="line">(<span class="name">defcommand</span> process-push  </div><div class="line">  &#123;<span class="symbol">:hystrix/group-key</span> <span class="string">"Push"</span> </div><div class="line">   <span class="symbol">:hystrix/command-key</span> <span class="string">"push"</span> </div><div class="line">   <span class="symbol">:hystrix/fallback-fn</span> fallback-add-notify&#125;</div><div class="line">  [req]</div><div class="line">  (<span class="name"><span class="builtin-name">let</span></span> [push-msg (<span class="name">parse-push-msg</span> req)</div><div class="line">        push-time (<span class="name">parse-push-time</span> req)]</div><div class="line">    (<span class="name">send-push</span> req push-msg push-time)</div><div class="line">    (<span class="name">save-push</span> push-msg push-time)))</div><div class="line"></div><div class="line">(<span class="name"><span class="builtin-name">defn</span></span> push-notification [req]</div><div class="line">  (<span class="name">binding</span> [*utc* (<span class="name"><span class="builtin-name">=</span></span> (<span class="symbol">:api-version</span> req) <span class="string">"1.1"</span>)]</div><div class="line">    do a lot of things ....</div><div class="line">      (<span class="name">process-push</span> req))</div></pre></td></tr></table></figure></div><p class="readmore"><a href="/2017/09/25/transmittable-thread-local/">Read More</a></p></div><div class="post"><h1 class="post-title"><a href="/2017/09/21/java-threadlocal/">Java ThreadLocal</a></h1><div class="post-meta">2017-09-21</div><div class="post-content"><p>很多地方会用到 ThreadLocal 这个工具，最近看到关于它引起内存泄露的问题，于是对 ThreadLocal 的实现以及使用需要注意的问题做了一些调查，记录一下。</p>
<h2 id="ThreadLocal-的实现"><a href="#ThreadLocal-的实现" class="headerlink" title="ThreadLocal 的实现"></a>ThreadLocal 的实现</h2><p>实现中几个关键的类和他们之间的引用关系大致上是下面这个图，在下面会说明这些箭头和方块的含义是什么。</p></div><p class="readmore"><a href="/2017/09/21/java-threadlocal/">Read More</a></p></div><div class="post"><h1 class="post-title"><a href="/2017/08/12/idea-import-gradle-project/">Intellij IDEA 导入 Gradle 项目</a></h1><div class="post-meta">2017-08-12</div><div class="post-content"><p>不知道为什么感觉现在比较新的项目好些都用的是 Gradle，而不是 Maven。IDEA 导入 Gradle 项目的时候遇到好几次问题了，在这里记录一下步骤，后面再次遇到要导入工程的时候好回看。</p>
<p>以下使用的是 MacOS，IDEA 版本为：IntelliJ IDEA Community 2016.3.3。</p></div><p class="readmore"><a href="/2017/08/12/idea-import-gradle-project/">Read More</a></p></div><div class="post"><h1 class="post-title"><a href="/2017/08/01/linux-receive-packet-3/">Linux 网络协议栈收消息过程-TCP Protocol Layer</a></h1><div class="post-meta">2017-08-01</div><div class="post-content"><p>漫漫长路，终于到了我们比较熟悉的 TCP 一层了，但很快就会发现上面这一大堆内容什么 NIC、中断、IP 路由之类的加起来可能都没有 TCP 一层的内容复杂，单是 goto 都比别的地方用的都多。因为 TCP 有状态，不同状态下收不到不同数据会有不同的行为，就导致了这个复杂度。为了不陷入 TCP 各种细节逻辑中，我们还是先只看最简单的连接处在 ESTABLISHED 状态的收消息过程。TCP 数据还分为 Normal 和 Urgent 两种，两种类型数据在处理过程中并不相同，为了简单起见，这里只大致介绍 Normal 的数据接收过程。</p></div><p class="readmore"><a href="/2017/08/01/linux-receive-packet-3/">Read More</a></p></div><div class="post"><h1 class="post-title"><a href="/2017/07/24/linux-receive-packet-2/">Linux 网络协议栈收消息过程-Per CPU Backlog</a></h1><div class="post-meta">2017-07-24</div><div class="post-content"><p>前面说到数据是交给 <code>netif_receive_skb</code> 来做进一步的处理，而<code>netif_receive_skb</code> 基本没干什么事情，主要事情都在 <a href="http://elixir.free-electrons.com/linux/v4.4/source/net/core/dev.c#L3983" target="_blank" rel="external">netif_receive_skb_internal</a> 中完成。此时数据处理都还在软中断的 Handler 中，<code>top</code> 的 <code>si</code> 能反应出 CPU 在这个阶段花费的时间。</p></div><p class="readmore"><a href="/2017/07/24/linux-receive-packet-2/">Read More</a></p></div><div class="post"><h1 class="post-title"><a href="/2017/07/23/linux-receive-packet-1/">Linux 网络协议栈收消息过程-Ring Buffer</a></h1><div class="post-meta">2017-07-23</div><div class="post-content"><p>想看能不能完整梳理一下收消息过程。从 NIC 收数据开始，到触发软中断，交付数据包到 IP 层再经由路由机制到 TCP 层，最终交付用户进程。会尽力介绍收消息过程中的各种配置信息，以及各种监控数据。知道了收消息的完整过程，了解了各种配置，明白了各种监控数据后才有可能在今后的工作中做优化配置。</p></div><p class="readmore"><a href="/2017/07/23/linux-receive-packet-1/">Read More</a></p></div><div class="post"><h1 class="post-title"><a href="/2017/07/02/RTM-max-connections/">实时通信系统并发连接数测试时需要调整的各种参数</a></h1><div class="post-meta">2017-07-02</div><div class="post-content"><p>维持大量并发连接是实时通信系统的关键能力之一，而要想测出一台服务器到底能支撑多少连接有时候会比较麻烦，需要涉及到好几个系统参数的调整，在这里希望能将遇到过的各种参数调整记录一下，以备后用。</p>
<p>以下所说连接均指 TCP 连接。</p>
<h2 id="客户端连接数限制"><a href="#客户端连接数限制" class="headerlink" title="客户端连接数限制"></a>客户端连接数限制</h2><p>首先需要明确一点是单个压测客户端（单个 IP）能承载的并发连接数是有限制的，这个上限是 65535。也就是说无论压测客户端所在机器性能有多强大，单个 IP 能和服务端建立的并发连接数就只有 65535 个，不可能更多。而从服务端角度来看，服务端能承受的并发连接数又远远不止 65535 个，只要服务器内存足够，CPU 足够强大，单机承载几十上百万的并发连接完全不是问题，所以我们经常能听到评价某些实时通信服务时候说单机能承担百万并发连接等。为什么从客户端和从服务端两个角度会得到不同的限制呢？</p></div><p class="readmore"><a href="/2017/07/02/RTM-max-connections/">Read More</a></p></div><div class="post"><h1 class="post-title"><a href="/2017/06/30/tcp-time-wait/">TCP TIME-WAIT</a></h1><div class="post-meta">2017-06-30</div><div class="post-content"><p>TIME-WAIT 是 TCP 挥手过程的一个状态。很多地方都对它有说明，这里只贴两个图唤起记忆。下面是 TCP 完整的状态图：</p>
<img src="/2017/06/30/tcp-time-wait/TCP-State.png" alt="来自：http://www.tcpipguide.com/free/t_TCPOperationalOverviewandtheTCPFiniteStateMachineF-2.htm" title="来自：http://www.tcpipguide.com/free/t_TCPOperationalOverviewandtheTCPFiniteStateMachineF-2.htm"></div><p class="readmore"><a href="/2017/06/30/tcp-time-wait/">Read More</a></p></div><div class="post"><h1 class="post-title"><a href="/2017/05/18/tcp-backlog/">TCP Backlog</a></h1><div class="post-meta">2017-05-18</div><div class="post-content"><p>这篇文章对 TCP Backlog 的说明写的特别好，<a href="http://veithen.github.io/2014/01/01/how-tcp-backlog-works-in-linux.html" target="_blank" rel="external">How TCP backlog works in Linux</a> 强烈建议看一看，希望这篇文章的地址不要变化，方便以后回顾。</p></div><p class="readmore"><a href="/2017/05/18/tcp-backlog/">Read More</a></p></div><nav class="page-navigator"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next</a></nav></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Network/" style="font-size: 15px;">Network</a> <a href="/tags/TCP/" style="font-size: 15px;">TCP</a> <a href="/tags/Bug/" style="font-size: 15px;">Bug</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Others/" style="font-size: 15px;">Others</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/Algorithm/" style="font-size: 15px;">Algorithm</a> <a href="/tags/Clojure/" style="font-size: 15px;">Clojure</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/11/netty-resource-leack-detector/">Netty 的资源泄露探测机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/25/transmittable-thread-local/">线程之间传递 ThreadLocal 对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/java-threadlocal/">Java ThreadLocal</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/12/idea-import-gradle-project/">Intellij IDEA 导入 Gradle 项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/01/linux-receive-packet-3/">Linux 网络协议栈收消息过程-TCP Protocol Layer</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/24/linux-receive-packet-2/">Linux 网络协议栈收消息过程-Per CPU Backlog</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/23/linux-receive-packet-1/">Linux 网络协议栈收消息过程-Ring Buffer</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/02/RTM-max-connections/">实时通信系统并发连接数测试时需要调整的各种参数</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/30/tcp-time-wait/">TCP TIME-WAIT</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/18/tcp-backlog/">TCP Backlog</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">A Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>